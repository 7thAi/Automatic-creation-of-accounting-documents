"""
Модуль для хранения данных о ГБУ и выбора организации пользователем.
"""
import logging
from typing import Dict, List, Tuple, Optional

logger = logging.getLogger(__name__)


class ReportData:
    """Хранит данные о ГБУ и предоставляет интерфейс для выбора организации."""
    
    def __init__(self):
        self.gbu: Optional[str] = None
        self.app_number: Optional[int] = None

        # Словарь для поиска номера раздела и номера приложения по ГБУ
        self.gbu_codes: Dict[str, Tuple[str, int]] = {
            "ГБУ «Автомобильные дороги ЦАО»": ("2.1", 1),
            "ГБУ «Жилищник района Арбат»": ("2.2", 2),
            "ГБУ «Жилищник Басманного района»": ("2.3", 3),
            "ГБУ «Жилищник района Замоскворечье»": ("2.4", 4),
            "ГБУ «Жилищник Красносельского района»": ("2.5", 5),
            "ГБУ «Жилищник Мещанского района»": ("2.6", 6),
            "ГБУ «Жилищник Пресненского района»": ("2.7", 7),
            "ГБУ «Жилищник Таганского района»": ("2.8", 8),
            "ГБУ «Жилищник района Тверской»": ("2.9", 9),
            "ГБУ «Жилищник района Хамовники»": ("2.10", 10),
            "ГБУ «Жилищник района Якиманка»": ("2.11", 11),
            "ГБУ «Автомобильные дороги САО»": ("3.1", 12),
            "ГБУ «Жилищник района Аэропорт»": ("3.2", 13),
            "ГБУ «Жилищник района Беговой»": ("3.3", 14),
            "ГБУ «Жилищник Бескудниковского района»": ("3.4", 15),
            "ГБУ «Жилищник района Войковский»": ("3.5", 16),
            "ГБУ «Жилищник района Восточное Дегунино»": ("3.6", 17),
            "ГБУ «Жилищник Головинского района»": ("3.7", 18),
            "ГБУ «Жилищник Дмитровского района»": ("3.8", 19),
            "ГБУ «Жилищник района Западное Дегунино»": ("3.9", 20),
            "ГБУ «Жилищник района Коптево»": ("3.10", 21),
            "ГБУ «Жилищник района Левобережный»": ("3.11", 22),
            "ГБУ «Жилищник Молжаниновского района»": ("3.12", 23),
            "ГБУ «Жилищник Савеловского района»": ("3.13", 24),
            "ГБУ «Жилищник района Сокол»": ("3.14", 25),
            "ГБУ «Жилищник Тимирязевского района»": ("3.15", 26),
            "ГБУ «Жилищник района Ховрино»": ("3.16", 27),
            "ГБУ «Жилищник Хорошевского района»": ("3.17", 28),
            "ГБУ «Автомобильные дороги СВАО»": ("4.1", 29),
            "ГБУ «Жилищник Алексеевского района»": ("4.2", 30),
            "ГБУ «Жилищник Алтуфьевского района»": ("4.3", 31),
            "ГБУ «Жилищник Бабушкинского района»": ("4.4", 32),
            "ГБУ «Жилищник района Бибирево»": ("4.5", 33),
            "ГБУ «Жилищник Бутырского района»": ("4.6", 34),
            "ГБУ «Жилищник района Лианозово»": ("4.7", 35),
            "ГБУ «Жилищник района Лосиноостровский»": ("4.8", 36),
            "ГБУ «Жилищник района Марфино»": ("4.9", 37),
            "ГБУ «Жилищник района Марьина Роща»": ("4.10", 38),
            "ГБУ «Жилищник Останкинского района»": ("4.11", 39),
            "ГБУ «Жилищник района Отрадное»": ("4.12", 40),
            "ГБУ «Жилищник района Ростокино»": ("4.13", 41),
            "ГБУ «Жилищник района Свиблово»": ("4.14", 42),
            "ГБУ «Жилищник района Северное Медведково»": ("4.15", 43),
            "ГБУ «Жилищник района Северный»": ("4.16", 44),
            "ГБУ «Жилищник района Южное Медведково»": ("4.17", 45),
            "ГБУ «Жилищник Ярославского района»": ("4.18", 46),
            "ГБУ «Автомобильные дороги ВАО»": ("5.1", 47),
            "ГБУ «Жилищник района Богородское»": ("5.2", 48),
            "ГБУ «Жилищник района Вешняки»": ("5.3", 49),
            "ГБУ «Жилищник района Восточное Измайлово»": ("5.4", 50),
            "ГБУ «Жилищник района Восточный»": ("5.5", 51),
            "ГБУ «Жилищник района Гольяново»": ("5.6", 52),
            "ГБУ «Жилищник Ивановского района»": ("5.7", 53),
            "ГБУ «Жилищник района Измайлово»": ("5.8", 54),
            "ГБУ «Жилищник района Косино-Ухтомский»": ("5.9", 55),
            "ГБУ «Жилищник района Метрогородок»": ("5.10", 56),
            "ГБУ «Жилищник района Новогиреево»": ("5.11", 57),
            "ГБУ «Жилищник района Новокосино»": ("5.12", 58),
            "ГБУ «Жилищник района Перово»": ("5.13", 59),
            "ГБУ «Жилищник района Преображенское»": ("5.14", 60),
            "ГБУ «Жилищник района Северное Измайлово»": ("5.15", 61),
            "ГБУ «Жилищник района Соколиная Гора»": ("5.16", 62),
            "ГБУ «Жилищник района Сокольники»": ("5.17", 63),
            "ГБУ «Автомобильные дороги ЮВАО»": ("6.1", 64),
            "ГБУ «Жилищник Выхино района Выхино-Жулебино»": ("6.2", 65),
            "ГБУ «Жилищник района Капотня»": ("6.3", 66),
            "ГБУ «Жилищник района Кузьминки»": ("6.4", 67),
            "ГБУ «Жилищник района Лефортово»": ("6.5", 68),
            "ГБУ «Жилищник района Люблино»": ("6.6", 69),
            "ГБУ «Жилищник района Марьино»": ("6.7", 70),
            "ГБУ «Жилищник района Некрасовка»": ("6.8", 71),
            "ГБУ «Жилищник района Нижегородский»": ("6.9", 72),
            "ГБУ «Жилищник района Печатники»": ("6.10", 73),
            "ГБУ «Жилищник района Рязанский»": ("6.11", 74),
            "ГБУ «Жилищник района Текстильщики»": ("6.12", 75),
            "ГБУ «Жилищник района Южнопортовый»": ("6.13", 76),
            "ГБУ «Автомобильные дороги ЮАО»": ("7.1", 77),
            "ГБУ «Жилищник района Бирюлево Восточное»": ("7.2", 78),
            "ГБУ «Жилищник района Бирюлево Западное»": ("7.3", 79),
            "ГБУ «Жилищник района Братеево»": ("7.4", 80),
            "ГБУ «Жилищник Даниловского района»": ("7.5", 81),
            "ГБУ «Жилищник Донского района»": ("7.6", 82),
            "ГБУ «Жилищник района Зябликово»": ("7.7", 83),
            "ГБУ «Жилищник района Москворечье-Сабурово»": ("7.8", 84),
            "ГБУ «Жилищник района Нагатино-Садовники»": ("7.9", 85),
            "ГБУ «Жилищник района Нагатинский затон»": ("7.10", 86),
            "ГБУ «Жилищник Нагорного района»": ("7.11", 87),
            "ГБУ «Жилищник района Орехово-Борисово Северное»": ("7.12", 88),
            "ГБУ «Жилищник района Орехово-Борисово Южное»": ("7.13", 89),
            "ГБУ «Жилищник района Царицыно»": ("7.14", 90),
            "ГБУ «Жилищник района Чертаново Северное»": ("7.15", 91),
            "ГБУ «Жилищник района Чертаново Центральное»": ("7.16", 92),
            "ГБУ «Жилищник района Чертаново Южное»": ("7.17", 93),
            "ГБУ «Автомобильные дороги ЮЗАО»": ("8.1", 94),
            "ГБУ «Жилищник района Академический»": ("8.2", 95),
            "ГБУ «Жилищник Гагаринского района»": ("8.3", 96),
            "ГБУ «Жилищник района Зюзино»": ("8.4", 97),
            "ГБУ «Жилищник района Коньково»": ("8.5", 98),
            "ГБУ «Жилищник района Котловка»": ("8.6", 99),
            "ГБУ «Жилищник района Ломоносовский»": ("8.7", 100),
            "ГБУ «Жилищник Обручевского района»": ("8.8", 101),
            "ГБУ «Жилищник района Северное Бутово»": ("8.9", 102),
            "ГБУ «Жилищник района Теплый Стан»": ("8.10", 103),
            "ГБУ «Жилищник района Черемушки»": ("8.11", 104),
            "ГБУ «Жилищник района Южное Бутово»": ("8.12", 105),
            "ГБУ «Жилищник района Ясенево»": ("8.13", 106),
            "ГБУ «Автомобильные дороги ЗАО»": ("9.1", 107),
            "ГБУ «Жилищник района Дорогомилово»": ("9.2", 108),
            "ГБУ «Жилищник района Крылатское»": ("9.3", 109),
            "ГБУ «Жилищник района Кунцево»": ("9.4", 110),
            "ГБУ «Жилищник Можайского района»": ("9.5", 111),
            "ГБУ «Жилищник района Ново-Переделкино»": ("9.6", 112),
            "ГБУ «Жилищник района Очаково-Матвеевское»": ("9.7", 113),
            "ГБУ «Жилищник района Проспект Вернадского»": ("9.8", 114),
            "ГБУ «Жилищник района Раменки»": ("9.9", 115),
            "ГБУ «Жилищник района Солнцево»": ("9.10", 116),
            "ГБУ «Жилищник района Тропарево-Никулино»": ("9.11", 117),
            "ГБУ «Жилищник района Филевский парк»": ("9.12", 118),
            "ГБУ «Жилищник района Фили-Давыдково»": ("9.13", 119),
            "ГБУ «Автомобильные дороги СЗАО»": ("10.1", 120),
            "ГБУ «Жилищник района Куркино»": ("10.2", 121),
            "ГБУ «Жилищник района Митино»": ("10.3", 122),
            "ГБУ «Жилищник района Покровское-Стрешнево»": ("10.4", 123),
            "ГБУ «Жилищник района Северное Тушино»": ("10.5", 124),
            "ГБУ «Жилищник района Строгино»": ("10.6", 125),
            "ГБУ «Жилищник района Хорошево-Мневники»": ("10.7", 126),
            "ГБУ «Жилищник района Щукино»": ("10.8", 127),
            "ГБУ «Жилищник района Южное Тушино»": ("10.9", 128),
            "ГБУ «Автомобильные дороги ЗелАО»": ("11.1", 129),
            "ГБУ «Жилищник ЗелАО»": ("11.2", 130),
            "ГБУ «Автомобильные дороги ТАО»": ("12.1", 131),
            "ГБУ «Автомобильные дороги НАО»": ("12.2", 132),
            "ГБУ «Жилищник района Бекасово»": ("12.3", 133),
            "ГБУ «Жилищник района Внуково»": ("12.4", 134),
            "ГБУ «Жилищник района Вороново»": ("12.5", 135),
            "ГБУ «Жилищник района Коммунарка»": ("12.6", 136),
            "ГБУ «Жилищник Краснопахорского района»": ("12.7", 137),
            "ГБУ «Жилищник района Троицк»": ("12.8", 138),
            "ГБУ «Жилищник Филимонковского района»": ("12.9", 139),
            "ГБУ «Жилищник района Щербинка»": ("12.10", 140)
        }

        # Маппинг округов к кодам секций и ГБУ Автомобильные дороги
        self.districts_map: Dict[str, Tuple[str, str]] = {
            "ЦАО": ("2", "ГБУ «Автомобильные дороги ЦАО»"),
            "САО": ("3", "ГБУ «Автомобильные дороги САО»"),
            "СВАО": ("4", "ГБУ «Автомобильные дороги СВАО»"),
            "ВАО": ("5", "ГБУ «Автомобильные дороги ВАО»"),
            "ЮВАО": ("6", "ГБУ «Автомобильные дороги ЮВАО»"),
            "ЮАО": ("7", "ГБУ «Автомобильные дороги ЮАО»"),
            "ЮЗАО": ("8", "ГБУ «Автомобильные дороги ЮЗАО»"),
            "ЗАО": ("9", "ГБУ «Автомобильные дороги ЗАО»"),
            "СЗАО": ("10", "ГБУ «Автомобильные дороги СЗАО»"),
            "ТиНАО": ("12", None)  # ТиНАО имеет несколько кодов
        }

    def select_option(self, options: List[str]) -> str:
        """
        Предлагает пользователю выбрать опцию из списка.
        
        Args:
            options: Список доступных опций.
            
        Returns:
            Выбранная опция.
        """
        for i, name in enumerate(options, 1):
            print(f"{i}. {name}")
        while True:
            try:
                choice = int(input("Номер: "))
                if 1 <= choice <= len(options):
                    return options[choice - 1]
            except ValueError:
                pass
            print("Некорректный ввод, попробуйте еще раз.")

    def _get_avd_by_district(self, district: str) -> str:
        """
        Возвращает АВД для указанного округа.
        
        Args:
            district: Название округа (например, "ЦАО").
            
        Returns:
            Полное название АВД.
        """
        if district in self.districts_map:
            _, avd = self.districts_map[district]
            if avd:
                return avd
        return None

    def _get_zhilischniki_by_district(self, district: str) -> List[str]:
        """
        Получает список Жилищников для указанного округа.
        
        Args:
            district: Название округа (например, "ЦАО").
            
        Returns:
            Список ГБУ Жилищников для округа.
        """
        if district not in self.districts_map:
            return []
        
        section_code, _ = self.districts_map[district]
        
        # Ищем все ГБУ с кодом секции, которые содержат "Жилищник"
        result = [
            gbu for gbu in self.gbu_codes.keys()
            if "Жилищник" in gbu and self.gbu_codes[gbu][0].startswith(f"{section_code}.")
        ]
        
        return sorted(result)

    def _select_zhilischnik(self) -> str:
        """
        Выбор жилищника: сначала выбираем округ, потом конкретного жилищника.
        Или выбираем сразу ГБУ «Жилищник ЗелАО».
        
        Returns:
            Выбранный ГБУ Жилищник.
        """
        # Собираем список округов + ЗелАО
        district_options = list(self.districts_map.keys())
        if "ГБУ «Жилищник ЗелАО»" in self.gbu_codes:
            district_options.append("ГБУ «Жилищник ЗелАО»")
        
        # Выбираем округ или ЗелАО
        print("\nВыберите округ или ГБУ «Жилищник ЗелАО»:")
        selected = self.select_option(district_options)
        
        # Если выбран Зеленоград, возвращаем его сразу
        if selected == "ГБУ «Жилищник ЗелАО»":
            return selected
        
        # Иначе выбираем жилищника из этого округа
        gbu_options = self._get_zhilischniki_by_district(selected)
        
        if not gbu_options:
            logger.warning(f"Не найдены Жилищники для округа {selected}")
            print(f"Ошибка: не найдены Жилищники для {selected}")
            return self._select_zhilischnik()  # Повторный выбор
        
        print(f"\nВыберите Жилищник в {selected}:")
        return self.select_option(gbu_options)

    def run(self) -> Tuple[str, int]:
        """
        Запускает интерактивный выбор организации.
        
        Returns:
            Кортеж (название ГБУ, номер приложения).
        """
        print("Выберите организацию:")
        org = self.select_option(["АВД", "Жилищник"])

        if org == "АВД":
            # Для АВД показываем все АВД
            print("\nВыберите АВД:")
            avd_options = sorted([
                gbu for gbu in self.gbu_codes.keys()
                if gbu.startswith("ГБУ «Автомобильные дороги")
            ])
            self.gbu = self.select_option(avd_options)
        else:
            # Для Жилищников показываем все сгруппированные по округам
            self.gbu = self._select_zhilischnik()

        # Получаем номер приложения
        if self.gbu in self.gbu_codes:
            _, self.app_number = self.gbu_codes[self.gbu]

        logger.info(f"Выбран: {self.gbu} (Приложение: {self.app_number})")
        print(f"\nВыбран: {self.gbu}")
        print(f"Приложение: {self.app_number}\n")
        
        return self.gbu, self.app_number